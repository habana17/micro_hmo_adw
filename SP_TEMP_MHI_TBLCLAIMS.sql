create
or replace PROCEDURE SP_TEMP_MHI_TBLCLAIMS AS BEGIN
/******************************************************************************

NAME:       SP_TEMP_MICRO_HMO
PURPOSE:   temp table to target

REVISIONS:
Ver          Date                  Author             Description
---------  ----------          ---------------  ------------------------------------
1.0        05/29/2025       Francis          1. Create SP_TEMP_MHI_TBLCLAIMS

NOTES:

 ******************************************************************************/
 
 --adw_prod_tgt.sp_adw_table_logs('TBLCLAIMS', 'SP_TEMP_MHI_TBLCLAIMS', SYSDATE, '', 'DELETE');
DELETE FROM adw_prod_tgt.TBLCLAIMS
WHERE
    1 = 1
    AND TRUNC (dateencoded) >= TRUNC (SYSDATE);
COMMIT;
--adw_prod_tgt.sp_adw_table_logs('TBLCLAIMS', 'SP_TEMP_MHI_TBLCLAIMS', SYSDATE, '', 'INSERT');
INSERT INTO
    adw_prod_tgt.TBLCLAIMS (
        claimcode,
        caseno,
        casetype,
        claimreceived,
        claimstatus,
        claimtype,
        subclaimtype,
        dateclosed,
        compcode,
        companyname,
        companystatus,
        membercode,
        memberno,
        membername,
        membertype,
        membercategory,
        levelcode,
        memberstatus,
        principalcode,
        principalname,
        principalno,
        oldplancode,
        planname,
        coveredfrom,
        coveredto,
        birthdate,
        gender,
        classorder,
        origeffectivity,
        policydivision,
        sharedplan,
        providercode,
        dateavailed,
        datedischarged,
        eligibilitystatus,
        loano,
        loaamount,
        loadateapproved,
        loaapprovedby,
        manualloano,
        manualloadateapproved,
        manualloaamount,
        finalamount,
        provideramount,
        pfamount,
        reamount,
        roomamount,
        phamount,
        discount,
        adjamount,
        eobamount,
        adjamountpf,
        incrementalcharges,
        incrementalamount,
        pfdiscount,
        claimshandlingfee,
        claimshandlingamount,
        finalreamount,
        nppfamount,
        npamount,
        refundamountpf,
        phpfamount,
        rerate,
        refundamount,
        duetomember,
        creditedamount,
        remarks,
        claims,
        claimsprocessor,
        roomtype,
        accredited,
        importedcode,
        jvnoap,
        eobno,
        basicclaim,
        majorclaim,
        spilloverclaim,
        origbasicclaim,
        origmajorclaim,
        origspilloverclaim,
        billno,
        intervininggroup,
        icdno,
        dvno,
        dateencoded,
        encodedby,
        rowmarker,
        asoadminfeetype,
        asoservicefeetype,
        asoservicefee,
        asosoano,
        provideraccess,
        casereceived,
        casestatus,
        contractno,
        relatedplangroup,
        benefitclass,
        plancode,
        operatorcode,
        eobtolerance,
        seen,
        hbadjdisapproved,
        pfadjdisapproved,
        hbadjapproved,
        pfadjapproved,
        clienttype,
        homestreet,
        homecity,
        homeprovince,
        zipcodehome,
        occupation,
        datedenied,
        denialreason,
        branchno,
        dateposted
    )
SELECT
    claimcode,
    caseno,
    casetype,
    claimreceived,
    claimstatus,
    claimtype,
    subclaimtype,
    dateclosed,
    compcode,
    companyname,
    companystatus,
    membercode,
    memberno,
    membername,
    membertype,
    membercategory,
    levelcode,
    memberstatus,
    principalcode,
    principalname,
    principalno,
    oldplancode,
    planname,
    coveredfrom,
    coveredto,
    birthdate,
    gender,
    classorder,
    origeffectivity,
    policydivision,
    sharedplan,
    providercode,
    dateavailed,
    datedischarged,
    eligibilitystatus,
    loano,
    loaamount,
    loadateapproved,
    loaapprovedby,
    manualloano,
    manualloadateapproved,
    manualloaamount,
    finalamount,
    provideramount,
    pfamount,
    reamount,
    roomamount,
    phamount,
    discount,
    adjamount,
    eobamount,
    adjamountpf,
    incrementalcharges,
    incrementalamount,
    pfdiscount,
    claimshandlingfee,
    claimshandlingamount,
    finalreamount,
    nppfamount,
    npamount,
    refundamountpf,
    phpfamount,
    rerate,
    refundamount,
    duetomember,
    creditedamount,
    remarks,
    claims,
    claimsprocessor,
    roomtype,
    accredited,
    importedcode,
    jvnoap,
    eobno,
    basicclaim,
    majorclaim,
    spilloverclaim,
    origbasicclaim,
    origmajorclaim,
    origspilloverclaim,
    billno,
    intervininggroup,
    icdno,
    dvno,
    dateencoded,
    encodedby,
    rowmarker,
    asoadminfeetype,
    asoservicefeetype,
    asoservicefee,
    asosoano,
    provideraccess,
    casereceived,
    casestatus,
    contractno,
    relatedplangroup,
    benefitclass,
    plancode,
    operatorcode,
    eobtolerance,
    seen,
    hbadjdisapproved,
    pfadjdisapproved,
    hbadjapproved,
    pfadjapproved,
    clienttype,
    homestreet,
    homecity,
    homeprovince,
    zipcodehome,
    occupation,
    datedenied,
    denialreason,
    branchno,
    dateposted
FROM
    adw_prod_tgt.TEMP_TBLCLAIMS;
COMMIT;
EXECUTE IMMEDIATE 'TRUNCATE TABLE adw_prod_tgt.TEMP_TBLCLAIMS';
--adw_prod_tgt.sp_adw_table_logs('TBLCLAIMS', 'SP_TEMP_MHI_TBLCLAIMS', SYSDATE, SYSDATE, 'UPDATE');
--transfer history 
--adw_prod_tgt.sp_adw_table_logs('TBLCLAIMS_HIST', 'SP_TEMP_MHI_TBLCLAIMS', SYSDATE, '', 'INSERT');
INSERT INTO --added by francis 05262025
    adw_prod_tgt.tblclaims_hist (
        claimcode,
        caseno,
        casetype,
        claimreceived,
        claimstatus,
        claimtype,
        subclaimtype,
        dateclosed,
        compcode,
        companyname,
        companystatus,
        membercode,
        memberno,
        membername,
        membertype,
        membercategory,
        levelcode,
        memberstatus,
        principalcode,
        principalname,
        principalno,
        oldplancode,
        planname,
        coveredfrom,
        coveredto,
        birthdate,
        gender,
        classorder,
        origeffectivity,
        policydivision,
        sharedplan,
        providercode,
        dateavailed,
        datedischarged,
        eligibilitystatus,
        loano,
        loaamount,
        loadateapproved,
        loaapprovedby,
        manualloano,
        manualloadateapproved,
        manualloaamount,
        finalamount,
        provideramount,
        pfamount,
        reamount,
        roomamount,
        phamount,
        discount,
        adjamount,
        eobamount,
        adjamountpf,
        incrementalcharges,
        incrementalamount,
        pfdiscount,
        claimshandlingfee,
        claimshandlingamount,
        finalreamount,
        nppfamount,
        npamount,
        refundamountpf,
        phpfamount,
        rerate,
        refundamount,
        duetomember,
        creditedamount,
        remarks,
        claims,
        claimsprocessor,
        roomtype,
        accredited,
        importedcode,
        jvnoap,
        eobno,
        basicclaim,
        majorclaim,
        spilloverclaim,
        origbasicclaim,
        origmajorclaim,
        origspilloverclaim,
        billno,
        intervininggroup,
        icdno,
        dvno,
        dateencoded,
        encodedby,
        rowmarker,
        asoadminfeetype,
        asoservicefeetype,
        asoservicefee,
        asosoano,
        provideraccess,
        casereceived,
        casestatus,
        contractno,
        relatedplangroup,
        benefitclass,
        plancode,
        operatorcode,
        eobtolerance,
        seen,
        hbadjdisapproved,
        pfadjdisapproved,
        hbadjapproved,
        pfadjapproved,
        clienttype,
        homestreet,
        homecity,
        homeprovince,
        zipcodehome,
        occupation,
        datedenied,
        denialreason,
        branchno,
        dateposted
    )
SELECT
    claimcode,
    caseno,
    casetype,
    claimreceived,
    claimstatus,
    claimtype,
    subclaimtype,
    dateclosed,
    compcode,
    companyname,
    companystatus,
    membercode,
    memberno,
    membername,
    membertype,
    membercategory,
    levelcode,
    memberstatus,
    principalcode,
    principalname,
    principalno,
    oldplancode,
    planname,
    coveredfrom,
    coveredto,
    birthdate,
    gender,
    classorder,
    origeffectivity,
    policydivision,
    sharedplan,
    providercode,
    dateavailed,
    datedischarged,
    eligibilitystatus,
    loano,
    loaamount,
    loadateapproved,
    loaapprovedby,
    manualloano,
    manualloadateapproved,
    manualloaamount,
    finalamount,
    provideramount,
    pfamount,
    reamount,
    roomamount,
    phamount,
    discount,
    adjamount,
    eobamount,
    adjamountpf,
    incrementalcharges,
    incrementalamount,
    pfdiscount,
    claimshandlingfee,
    claimshandlingamount,
    finalreamount,
    nppfamount,
    npamount,
    refundamountpf,
    phpfamount,
    rerate,
    refundamount,
    duetomember,
    creditedamount,
    remarks,
    claims,
    claimsprocessor,
    roomtype,
    accredited,
    importedcode,
    jvnoap,
    eobno,
    basicclaim,
    majorclaim,
    spilloverclaim,
    origbasicclaim,
    origmajorclaim,
    origspilloverclaim,
    billno,
    intervininggroup,
    icdno,
    dvno,
    dateencoded,
    encodedby,
    rowmarker,
    asoadminfeetype,
    asoservicefeetype,
    asoservicefee,
    asosoano,
    provideraccess,
    casereceived,
    casestatus,
    contractno,
    relatedplangroup,
    benefitclass,
    plancode,
    operatorcode,
    eobtolerance,
    seen,
    hbadjdisapproved,
    pfadjdisapproved,
    hbadjapproved,
    pfadjapproved,
    clienttype,
    homestreet,
    homecity,
    homeprovince,
    zipcodehome,
    occupation,
    datedenied,
    denialreason,
    branchno,
    dateposted
FROM
    (
        SELECT
            claimcode,
            caseno,
            casetype,
            claimreceived,
            claimstatus,
            claimtype,
            subclaimtype,
            dateclosed,
            compcode,
            companyname,
            companystatus,
            membercode,
            memberno,
            membername,
            membertype,
            membercategory,
            levelcode,
            memberstatus,
            principalcode,
            principalname,
            principalno,
            oldplancode,
            planname,
            coveredfrom,
            coveredto,
            birthdate,
            gender,
            classorder,
            origeffectivity,
            policydivision,
            sharedplan,
            providercode,
            dateavailed,
            datedischarged,
            eligibilitystatus,
            loano,
            loaamount,
            loadateapproved,
            loaapprovedby,
            manualloano,
            manualloadateapproved,
            manualloaamount,
            finalamount,
            provideramount,
            pfamount,
            reamount,
            roomamount,
            phamount,
            discount,
            adjamount,
            eobamount,
            adjamountpf,
            incrementalcharges,
            incrementalamount,
            pfdiscount,
            claimshandlingfee,
            claimshandlingamount,
            finalreamount,
            nppfamount,
            npamount,
            refundamountpf,
            phpfamount,
            rerate,
            refundamount,
            duetomember,
            creditedamount,
            remarks,
            claims,
            claimsprocessor,
            roomtype,
            accredited,
            importedcode,
            jvnoap,
            eobno,
            basicclaim,
            majorclaim,
            spilloverclaim,
            origbasicclaim,
            origmajorclaim,
            origspilloverclaim,
            billno,
            intervininggroup,
            icdno,
            dvno,
            dateencoded,
            encodedby,
            rowmarker,
            asoadminfeetype,
            asoservicefeetype,
            asoservicefee,
            asosoano,
            provideraccess,
            casereceived,
            casestatus,
            contractno,
            relatedplangroup,
            benefitclass,
            plancode,
            operatorcode,
            eobtolerance,
            seen,
            hbadjdisapproved,
            pfadjdisapproved,
            hbadjapproved,
            pfadjapproved,
            clienttype,
            homestreet,
            homecity,
            homeprovince,
            zipcodehome,
            occupation,
            datedenied,
            denialreason,
            branchno,
            dateposted,
            ROW_NUMBER() OVER (
                PARTITION BY
                    claimcode
                ORDER BY
                    CASE
                        WHEN dateposted IS NULL THEN 1
                        ELSE 0
                    END,
                    dateposted desc
            ) AS Row_Num
        FROM
            adw_prod_tgt.TBLCLAIMS
        WHERE
            claimcode IN (
                SELECT
                    claimcode
                FROM
                    tblclaims
                GROUP BY
                    claimcode
                HAVING
                    COUNT(*) > 1
            )
    )
WHERE
    Row_Num > 1;
COMMIT;
DELETE FROM adw_prod_tgt.TBLCLAIMS --added by francis 05262025
WHERE
    ROWID IN (
        SELECT
            ROWID
        FROM
            (
                SELECT
                    ROWID,
                    ROW_NUMBER() OVER (
                        PARTITION BY
                            claimcode
                        ORDER BY
                            CASE
                                WHEN dateposted IS NULL THEN 1
                                ELSE 0
                            END,
                            dateposted DESC
                    ) AS Row_Num
                FROM
                    adw_prod_tgt.TBLCLAIMS
            )
        WHERE
            Row_Num > 1
    );
COMMIT;
--adw_prod_tgt.sp_adw_table_logs('TBLCLAIMS_HIST', 'SP_TEMP_MHI_TBLCLAIMS', SYSDATE, SYSDATE, 'UPDATE');
 
 
 END SP_TEMP_MHI_TBLCLAIMS;